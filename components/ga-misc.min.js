angular.module("ngAmbassador.misc",["ngAmbassador.services"]).directive("fillWindow",["$timeout",function($timeout){return{scope:{subtractElems:"@",applyToChildren:"@",additionalOffset:"@",ignore:"@"},link:function(scope,element,attrs){function resizeElements(){var windowWidth=angular.isDefined(attrs.windowWidth)?attrs.windowWidth:window.innerWidth;if(resize=!0,angular.isDefined(scope.ignore)){var ignoreSizes=scope.ignore.split(";");angular.forEach(ignoreSizes,function(size){windowWidth>=screenSizes[size].minWidth&&windowWidth<=screenSizes[size].maxWidth&&(resize=!1)}),resize?adjustElemHeight():resetHeight()}else adjustElemHeight()}function resetHeight(){if("true"!==scope.applyToChildren)element[0].style.minHeight="0px";else{var childElems=element[0].children;angular.forEach(childElems,function(child){child.style.minHeight="0px"})}}function adjustElemHeight(){resetHeight();var documentHeight=document.documentElement.scrollHeight>document.documentElement.clientHeight?document.documentElement.scrollHeight:document.documentElement.clientHeight,subtractHeight=0;if(angular.isDefined(scope.subtractElems)&&""!==scope.subtractElems){var elements=scope.subtractElems.split(";");angular.forEach(elements,function(elem){subtractHeight+=parseFloat(window.getComputedStyle(document.getElementsByClassName(elem)[0]).height)})}if(subtractHeight+=element[0].offsetTop,"true"!==scope.applyToChildren)element[0].style.minHeight=documentHeight-subtractHeight-(angular.isUndefined(scope.additionalOffset)?0:scope.additionalOffset)+"px";else{var childElems=element[0].children;angular.forEach(childElems,function(child){child.style.minHeight=documentHeight-subtractHeight-(angular.isUndefined(scope.additionalOffset)?0:scope.additionalOffset)+"px"})}}function checkElementHeights(){if("true"!==scope.applyToChildren)parseInt(window.getComputedStyle(element[0]).height)>parseInt(window.getComputedStyle(element[0]).minHeight)&&resizeElements();else for(var childElems=element[0].children,i=0;i<childElems.length;i++)if(parseInt(window.getComputedStyle(childElems[i]).height)>parseInt(window.getComputedStyle(childElems[i]).minHeight)){resizeElements();break}}var timeout,screenSizes={"extra-small":{minWidth:0,maxWidth:767},small:{minWidth:768,maxWidth:991},medium:{minWidth:992,maxWidth:1199},large:{minWidth:1200,maxWidth:1/0}},resize=!0;scope.$watch(function(){resizeElements()}),window.onresize=function(){$timeout.cancel(timeout),resizeElements(),timeout=$timeout(function(){checkElementHeights()},50)}}}}]).directive("clickAnywhereButHere",["$document",function($document){return{restrict:"A",link:function(scope,elem,attr,ctrl){elem.bind("click",function(e){e.stopPropagation()}),$document.bind("click",function(){scope.$apply(attr.clickAnywhereButHere)})}}}]).directive("fillParent",["$window",function($window){return{link:function(scope,element,attrs){function setHeight(){var parentHeight=window.getComputedStyle(element.parent()[0]).height;element[0].style.minHeight=parentHeight}scope.$watch(function(){setHeight()}),angular.element($window).bind("resize",function(){setHeight()})}}}]).directive("equalizeHeights",["$window",function($window){return{link:function(scope,element,attrs){function goThroughRows(){angular.forEach(targets,function(target,index){target.style.height="auto",0==index?(currentRowOffset=target.offsetTop,row.push(target),height=window.getComputedStyle(target).height):target.offsetTop!=currentRowOffset?(changeHeight(height),row=[],row.push(target),currentRowOffset=target.offsetTop,height=window.getComputedStyle(target).height):(row.push(target),parseFloat(window.getComputedStyle(target).height)>parseFloat(height)&&(height=window.getComputedStyle(target).height)),index==targets.length-1&&(row.push(target),parseFloat(window.getComputedStyle(target).height)>parseFloat(height)&&(height=window.getComputedStyle(target).height),changeHeight(height),row=[],currentRowOffset=0,height=0)})}function changeHeight(height){angular.forEach(row,function(target){target.style.height=height})}var targets=element[0].children,currentRowOffset=0,height=0,row=[];element[0].style.overflow="hidden",scope.$watch(function(){goThroughRows()}),angular.element($window).bind("resize",function(){goThroughRows()})}}}]).directive("gaEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.gaEnter)}),event.preventDefault())})}}).directive("gaLoader",["$timeout","$window",function($timeout,$window){return{restrict:"E",replace:!0,template:'<div ng-class="{\'fade-in\':loading===true, \'fade-out\':loading===false }" class="ga-loader"><div ng-if="showLoader" class="ga-spinner"><span class="loader-text">Loading</span><svg class="spinner" width="100px" height="100px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg"><circle class="path" fill="none" stroke-width="5" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div>',scope:{loading:"=",activePositioning:"@"},link:function(scope,elm,attrs){function keepSpinnerInView(){if(scope.showLoader){var tableBounds=scope.thisElement.getBoundingClientRect(),spinner=angular.element(scope.thisElement.children[0]),isTopHidden=tableBounds.top<0,isBottomHidden=tableBounds.bottom>window.innerHeight,spinnerTop=null;if(isTopHidden&&isBottomHidden)spinnerTop=-tableBounds.top+window.innerHeight/2;else if(isTopHidden){var y=(tableBounds.height-tableBounds.top)/2;spinnerTop=Math.min(y,tableBounds.height-50)}else if(isBottomHidden){var y=(tableBounds.height-(tableBounds.bottom-window.innerHeight))/2;spinnerTop=Math.max(50,y)}spinner.css("top",spinnerTop?spinnerTop+"px":"")}}scope.thisElement=elm[0],scope.showLoader=scope.loading===!0,scope.activeSpinnerPositioning=!0,"false"===scope.activePositioning&&(scope.activeSpinnerPositioning=!1),scope.$watch("loading",function(newValue,oldValue){scope.loading?(scope.showLoader=!0,scope.activeSpinnerPositioning&&$timeout(keepSpinnerInView,1)):newValue!==oldValue&&$timeout(function(){scope.showLoader=!1},300)}),scope.activeSpinnerPositioning&&angular.element($window).bind("resize scroll",keepSpinnerInView)}}}]).directive("gaValueTemplate",["$compile",function($compile){return{restrict:"E",scope:{value:"=",responsive:"=",compression:"=",min:"=",max:"=",scopeLevel:"@"},replace:!0,template:"<div ng-style='{fontSize:fontSize}'></div>",link:function(scope,element,attrs){element.html(scope.value),void 0===scope.scopeLevel&&(scope.scopeLevel=3);for(var valueScope=scope,i=1;i<=scope.scopeLevel;i++)valueScope=valueScope.$parent;$compile(element.contents())(valueScope),scope.compressor=scope.compression||1,scope.minFontSize=scope.min||Number.NEGATIVE_INFINITY,scope.maxFontSize=scope.max||Number.POSITIVE_INFINITY,scope.elementWidth=element[0].offsetWidth,scope.resizer=function(){scope.elementWidth=element[0].offsetWidth,scope.fontSize=Math.max(Math.min(scope.elementWidth/(10*scope.compressor),parseFloat(scope.maxFontSize)),parseFloat(scope.minFontSize))+"px"},scope.responsive&&(scope.resizer(),scope.$watch("value",function(){scope.resizer()}),angular.element(window).bind("resize",function(){scope.$apply(scope.resizer)}),scope.$watch(function(){return element[0].offsetWidth},function(){scope.resizer()}))}}}]).directive("gaCurrency",["$filter",function($filter){return{restrict:"E",replace:!0,scope:{type:"=",amount:"=",pointsLabel:"=",currency:"=",typesConfig:"=",showTooltip:"@"},template:"<div><span ng-if='showTooltip' tooltip='{{displayAmount}}' tooltip-placement='{{showTooltip}}'>{{displayAmount}}</span><span ng-if='!showTooltip'>{{displayAmount}}</span></div>",link:function(scope,element,attrs,ctrl){var currencies={USD:"$",GBP:"£",SGD:"S$",EUR:"€",AUD:"A$",ZAR:"R",BRL:"R$",CAD:"C$",NZD:"NZ$"},updateAmount=function(){var filter=$filter("currency"),amountTest=parseFloat(scope.amount);angular.isDefined(scope.type)&&angular.isDefined(scope.typesConfig)&&-1!==scope.typesConfig.nonMonetary.indexOf(scope.type)?scope.displayAmount=filter(amountTest,"",2)+" "+scope.pointsLabel:scope.displayAmount=filter(amountTest,currencies[scope.currency],2)};scope.$watch("amount",function(){updateAmount()})}}}]).directive("gaAvatar",["$filter",function($filter){return{restrict:"E",scope:{image:"=",disableFade:"=",alt:"@"},template:"<div class='ga-avatar'><img ng-src='{{image}}' ng-class='{ \"fade-in\": avatarLoaded===true }' ></div>",link:function(scope,element,attrs){scope.disableFade!==!0?element.find("img").bind("load",function(event){scope.avatarLoaded=!0,scope.$$phase||scope.$apply()}):scope.avatarLoaded=!0}}}]).directive("gaDynamicTooltip",["$window",function($window){return{restrict:"A",transclude:!0,template:'<div tooltip="{{tooltipText}}" tooltip-placement="{{tooltipPlacement}}" ng-transclude></div>',link:function(scope,element,attrs){function tooltipHandler(showTooltip){scope.tooltipText=showTooltip?attrs.gaDynamicTooltip:""}scope.tooltipText="",scope.tooltipPlacement=angular.isDefined(attrs.gaDynamicTooltipPlacement)?attrs.gaDynamicTooltipPlacement:"top",scope.minWidthToShowTooltip=angular.isDefined(attrs.showTooltipAfter)?parseInt(attrs.showTooltipAfter):!1;var count=0,waitForTooltipToRender=scope.$watch(function(){var innerWidth=element.find("span")[0].getBoundingClientRect().width,outerWidth=element.children()[0].getBoundingClientRect().width;return count++,count>=5&&waitForTooltipToRender(),innerWidth>0&&outerWidth>0?scope.minWidthToShowTooltip?innerWidth>scope.minWidthToShowTooltip:innerWidth>=outerWidth:void 0},function(showTooltip){tooltipHandler(showTooltip)});angular.element($window).bind("resize",function(){var innerWidth=element.find("span")[0].getBoundingClientRect().width,outerWidth=element.children()[0].getBoundingClientRect().width;innerWidth>0&&outerWidth>0&&tooltipHandler(scope.minWidthToShowTooltip?innerWidth>scope.minWidthToShowTooltip:innerWidth>=outerWidth)})}}}]).directive("gaEnter",function(){return function(scope,element,attrs){element.bind("keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.gaEnter)}),event.preventDefault())})}});