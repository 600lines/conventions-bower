angular.module("ngAmbassador.activityFeed",["ngAmbassador.services","ngAmbassador.api"]).directive("gaActivityFeed",["$api","$timeout","$promiseKeeper",function($api,$timeout,$promiseKeeper){"use strict";return{restrict:"E",scope:{endpoint:"@",numberOfItems:"@",columns:"@",feedTitle:"@",companyCurrency:"@",companyPoints:"@",ambassadorTemplate:"=",config:"=",filters:"="},templateUrl:"../ambassador/templates/activity-feed.html",link:function(scope){function loadActivity(){scope.activities=[],scope.feedColumns=[];var requestData=void 0!==scope.filters?angular.copy(scope.filters):{};requestData.page_size=scope.numberOfItems;var loadingPromise=$promiseKeeper.add();$api.use("default").all(scope.endpoint).getList(requestData).then(function(data){loadingPromise.deferred.resolve(),scope.activities=data,1==scope.columns?(getOrientation(scope.activities),scope.feedColumns[0]=scope.activities):(itemsPerColumn=Math.ceil(data.length/scope.columns),splitIntoColumns(scope.activities))})}function splitIntoColumns(data){for(var i=0;i<scope.columns;i++)scope.feedColumns.push([]),angular.forEach(data,function(activity,index){index>=itemsPerColumn*i&&itemsPerColumn*(i+1)>index&&(activity.orientation="right",scope.feedColumns[i].push(activity))})}function getOrientation(data){angular.forEach(data,function(activity,index){activity.orientation=0===index?"left":activity.type!==data[index-1].type?"left"===data[index-1].orientation?"right":"left":data[index-1].orientation})}var itemsPerColumn=Math.ceil(scope.numberOfItems/scope.columns),initialized=!1;scope.$watch("filters",function(newValue,oldValue){(newValue!==oldValue||initialized===!1)&&(loadActivity(),initialized=!0)},!0),scope.activityTime=function(dateTime){var now=(new Date).toUTCString(),diff=new Date(now)-new Date(dateTime),readableDiff=0,timeUnit="seconds";return diff>31104e6?(readableDiff=Math.floor(diff/31104e6),timeUnit=1===readableDiff?"year":"years"):diff>2592e6?(readableDiff=Math.floor(diff/2592e6),timeUnit=1===readableDiff?"month":"months"):diff>864e5?(readableDiff=Math.floor(diff/864e5),timeUnit=1===readableDiff?"day":"days"):diff>36e5?(readableDiff=Math.floor(diff/36e5),timeUnit=1===readableDiff?"hour":"hours"):diff>6e4?(readableDiff=Math.floor(diff/6e4),timeUnit=1===readableDiff?"minute":"minutes"):(readableDiff=Math.floor(diff/1e3),timeUnit=1===readableDiff?"second":"seconds"),readableDiff+" "+timeUnit+" ago"}}}}]);