angular.module("ngAmbassador.services",[]).factory("$helper",function(){return{colorLuminance:function(hex,lum){hex=String(hex).replace(/[^0-9a-f]/gi,""),hex.length<6&&(hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]),lum=lum||0;var c,i,rgb="#";for(i=0;3>i;i++)c=parseInt(hex.substr(2*i,2),16),c=Math.round(Math.min(Math.max(0,c+c*lum),255)).toString(16),rgb+=("00"+c).substr(c.length);return rgb},sum:function(obj,key){for(var sum=0,i=0;i<obj.length;i++)sum+=parseFloat(obj[i][key]);return sum}}}).factory("$promiseKeeper",["$q","$timeout",function($q,$timeout){var $promiseKeeper={},promises=[],promiseData=[],keeperStartTime=null,keeperConfig={expect:0,timeout:30,success:function(){},loading:function(){}},promiseConfig={id:"promise",status:"new"},_startPromising=function(){"function"==typeof keeperConfig.loading&&keeperConfig.loading();var promiseCount=promises.length;$q.all(promises)["finally"](function(){"function"==typeof keeperConfig.success&&promises.length===promiseCount&&(keeperConfig.success(),_resetPromises())})},_resetPromises=function(){promises=[],promiseData=[],keeperStartTime=null};return $promiseKeeper.getActive=function(){return promiseData.length>0?promiseData:!1},$promiseKeeper.config=function(config){keeperConfig=angular.extend(keeperConfig,config)},$promiseKeeper.add=function(config){var deferred=$q.defer(),promiseConf=angular.extend(angular.copy(promiseConfig),config);promiseConf.promise=deferred.promise,promiseConf.deferred=deferred,promiseConf.status="loading",promiseConf.id="promise"+(parseInt(promises.length)+1),promiseConf.start=(new Date).getTime(),promiseData.push(promiseConf),promises.push(deferred.promise),null===keeperStartTime&&(keeperStartTime=(new Date).getTime());var promiseTimeout=$timeout(function(){promiseConf.status="timeout",promiseConf.deferred.reject(promiseConf)},1e3*parseInt(keeperConfig.timeout)-(promiseConf.start-keeperStartTime));return promiseConf.promise.then(function(){$timeout.cancel(promiseTimeout),promiseConf.status="success"}),_startPromising(),promiseConf},$promiseKeeper}]).factory("$script",["$q",function($q){var $script={};return $script.load=function(urls){var promises=[];return angular.forEach(urls,function(url){var scriptPromise=$q.defer();promises.push(scriptPromise.promise);for(var head=document.getElementsByTagName("head")[0],script=null,allScripts=head.getElementsByTagName("script"),i=allScripts.length-1;i>=0;i--){var sc=allScripts[i],gaLoaded=sc.getAttribute("ga-loaded");if(null!==gaLoaded&&url===sc.getAttribute("src")){if("true"===gaLoaded)return void scriptPromise.resolve();script=sc;break}}null===script&&(script=document.createElement("script"),script.type="text/javascript",script.src=url,script.setAttribute("ga-loaded","false"),head.appendChild(script)),script.addEventListener?script.addEventListener("load",function(){script.setAttribute("ga-loaded","true"),scriptPromise.resolve()},!1):script.onreadystatechange=function(){"loaded"===script.readyState&&(script.setAttribute("ga-loaded","true"),scriptPromise.resolve())}}),$q.all(promises)},$script}]).factory("$diff",[function(){var $diff={};return $diff.compare=function(original,toCompare,emptyStringIsNotNull){var diffObj,objectDiff={};return objectDiff.diff=function diff(a,b){if(a===b)return!1;var toSave={},equal=!0;for(var key in a)if(a[key]!==b[key]){if(!emptyStringIsNotNull&&(null===a[key]&&""===b[key]||""===a[key]&&null===b[key]))continue;var typeA=typeof a[key],typeB=typeof b[key];if("object"===typeA&&"object"===typeB){if(!_.isArray(a[key])&&!_.isArray(b[key]))if(angular.isDate(a[key])&&angular.isDate(b[key]))new Date(a[key]).setHours(0,0,0,0)!==new Date(b[key]).setHours(0,0,0,0)&&(equal=!1,toSave[key]=b[key]);else if(null===a[key]&&angular.isDate(b[key]))equal=!1,toSave[key]=b[key];else{var valueDiff=diff(a[key],b[key]);valueDiff!==!1&&(equal=!1,toSave[key]=valueDiff)}}else"function"===typeA||"function"===typeB||_.isArray(a[key])||_.isArray(b[key])||(equal=!1,toSave[key]=b[key])}return equal?!1:toSave},diffObj=objectDiff.diff(original,toCompare)},$diff}]);